var Qe=Object.defineProperty;var Me=(o,e,t)=>e in o?Qe(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var p=(o,e,t)=>Me(o,typeof e!="symbol"?e+"":e,t);import{H as Oe,g as Fe}from"../chunks/CroP3Izp.js";import{h as M,C as me,t as ge,E as re,F as Re,z as Te,al as Ae,q as Ne,x as ke,au as He,j as We}from"../chunks/B11Zin6s.js";import"../chunks/Bg9kRutz.js";import{i as de}from"../chunks/BxiFlMN0.js";import{p as he,aK as Ue,t as H,a as pe,c as i,O as l,a7 as _,s as A,r as c,a8 as Q,a0 as oe,a6 as Ie,a9 as ie,aa as Pe,f as le,n as fe,aj as ce,g as Ee,aJ as je,aU as Le}from"../chunks/D2BM3cv1.js";import{e as ue,a as q,t as C,s as L,d as ze}from"../chunks/CRc66pB2.js";import{r as ve,s as te,a as U}from"../chunks/DoWIUU7Y.js";import{b as Ce}from"../chunks/BuXNm5Ru.js";import{p as N,i as se}from"../chunks/C5aigyhq.js";import{s as ye,a as W}from"../chunks/BRe-H2Zv.js";import{N as Be}from"../chunks/Qa4b1zFn.js";import{e as be,i as we}from"../chunks/BbljCwWF.js";import{a as Ge,b as _e}from"../chunks/BJx3CnTf.js";import{p as De}from"../chunks/Bfc47y5P.js";import{S as Je}from"../chunks/53vWaFaO.js";import{s as Ke,f as Se}from"../chunks/DswakvRO.js";function Xe(o,e){throw new Oe(o,e)}new TextEncoder;async function Ve({params:o}){const e=M.bookCollections.find(t=>t.id===o.collection);if(!e)throw Xe(404);return{collection:e.id}}const Xt=Object.freeze(Object.defineProperty({__proto__:null,load:Ve},Symbol.toStringTag,{value:"Module"}));var Ye=C('<button class="m-0.5 rounded w-8 h-10"> </button>'),Ze=C('<div class="dy-form-control m-2"><div class="special-characters"></div></div>'),et=C('<div class="dy-form-control max-w-xs px-4 my-2"><label class="dy-label cursor-pointer"><span class="dy-label-text"><bdi> </bdi></span> <input type="checkbox" class="dy-toggle"></label></div>'),tt=C('<div class="dy-form-control max-w-xs px-4 my-2"><label class="dy-label cursor-pointer"><span class="dy-label-text"><bdi> </bdi></span> <input type="checkbox" class="dy-toggle"></label></div>'),st=C('<form class="w-full max-w-screen-md p-4"><div class="dy-form-control mb-4"><label class="dy-input-group w-full flex"><input id="searchbar" type="text" class="flex-grow px-4 py-2 mx-2 dy-input min-w-0 dy-input-bordered" size="1" inputmode="search" enterkeyhint="search"> <button class="dy-btn mx-2 flex-none bg-gray-200"><!></button></label></div> <!> <!> <!></form>');function rt(o,e){var Y;he(e,!1);const[t,r]=ye(),n=()=>W(ge,"$t",t),d=()=>W(Re,"$s",t),f=()=>W(me,"$themeColors",t);let D=N(e,"phrase",12),P=N(e,"wholeWords",12),O=N(e,"matchAccents",12),S=Q();const F=((Y=M.mainFeatures["input-buttons"])==null?void 0:Y.split(" ").filter(m=>m.length))??[];function E(m,s){s.preventDefault();const a=l(S).selectionStart,u=l(S).selectionEnd;D(D().slice(0,a)+m+D().slice(u)),l(S).focus(),requestAnimationFrame(()=>l(S).setSelectionRange(a+m.length,a+m.length))}let g=Q(!1);const R=Ue();function $(){D()&&(_(g,!0),setTimeout(()=>{_(g,!1)},50),R("submit",{phrase:D(),wholeWords:P(),matchAccents:O()}))}de();var h=st(),y=i(h),b=i(y),v=i(b);ve(v);const J=oe(()=>re(d()["ui.search.entry-text"]));Ce(v,m=>_(S,m),()=>l(S));var z=A(v,2);const B=oe(()=>re(d()["ui.search.button"]));var X=i(z);Je(X,{get color(){return f().SearchButtonTextColor}}),c(z),c(b),c(y);var K=A(y,2);{var G=m=>{var s=Ze(),a=i(s);be(a,5,()=>F,we,(u,x)=>{var w=Ye();const k=oe(()=>re(d()["ui.search.buttons"]));var I=i(w,!0);c(w),H(()=>{te(w,"style",l(k)),L(I,l(x))}),ue("click",w,T=>E(l(x),T)),q(u,w)}),c(a),c(s),q(m,s)};se(K,m=>{M.mainFeatures["search-input-buttons"]&&F.length>0&&m(G)})}var j=A(K,2);{var ne=m=>{var s=et(),a=i(s),u=i(a);const x=oe(()=>re(d()["ui.search.checkbox"]));var w=i(u),k=i(w,!0);c(w),c(u);var I=A(u,2);ve(I),c(a),c(s),H(()=>{te(u,"style",l(x)),L(k,n().Search_Match_Whole_Words)}),_e(I,P),q(m,s)};se(j,m=>{M.mainFeatures["search-whole-words-show"]&&m(ne)})}var V=A(j,2);{var ae=m=>{var s=tt(),a=i(s),u=i(a);const x=oe(()=>re(d()["ui.search.checkbox"]));var w=i(u),k=i(w,!0);c(w),c(u);var I=A(u,2);ve(I),c(a),c(s),H(()=>{te(u,"style",l(x)),L(k,n().Search_Match_Accents)}),_e(I,O),q(m,s)};se(V,m=>{M.mainFeatures["search-accents-show"]&&m(ae)})}c(h),H(()=>{v.readOnly=l(g),te(v,"placeholder",n().Search_Text_Hint),te(v,"style",l(J)),U(v,"min-width","0"),U(v,"background-color",f().BackgroundColor),U(v,"border-color",f().DividerColor),te(z,"style",l(B)),U(z,"border-color",f().DividerColor)}),Ge(v,D),ue("click",z,De($)),q(o,h),pe(),r()}var ot=C("<span> </span>"),nt=C('<div class="search-result-block w-full transition-shadow duration-300 hover:shadow-lg cursor-pointer"><button class="text-start"><div class="search-result-reference flex"><h1> </h1></div> <div class="search-result-context flex"><p class="text-start"></p></div></button></div>');function at(o,e){he(e,!1);let t=N(e,"docSet",8),r=N(e,"collection",8),n=N(e,"result",8);M.bookCollections.find(h=>h.id===r()).style.textDirection.toLowerCase();function d(h){const y=f(h.reference),b=M.bookCollections.find(J=>J.id===r()).features["ref-chapter-verse-separator"];let v=y.book;return y.chapter&&(v+=" "+y.chapter,y.verses&&(v+=b+y.verses)),v}function f(h){const y=Ke(M,h.collection,h.bookCode);return{book:D(h.bookCode),chapter:Se(y,h.chapter),verses:Se(y,h.verses)}}function D(h){return M.bookCollections.filter(v=>v.id===r())[0].books.filter(v=>v.id===h)[0].name}function P(){Te({docSet:t(),collection:r(),book:n().reference.bookCode,chapter:n().reference.chapter,verse:n().reference.verses})}de();var O=nt(),S=i(O),F=i(S),E=i(F),g=i(E,!0);H(()=>L(g,d(n()))),c(E),c(F);var R=A(F,2),$=i(R);be($,5,()=>n().chunks,we,(h,y)=>{var b=ot(),v=i(b,!0);c(b),H(()=>{U(b,"font-weight",l(y).matchesQuery?"bold":"normal"),U(b,"text-decoration",l(y).matchesQuery?"underline":"none"),L(v,l(y).content)}),q(h,b)}),c($),c(R),c(S),c(O),ue("click",S,De(P)),q(o,O),pe()}var ct=C('<div class="py-4 flex justify-center"><p> </p></div>'),it=C('<p><bdi> </bdi></p> <span class="spin svelte-1r2kkus"></span>',1),lt=C('<!> <div class="py-4"></div>',1),ut=C("<bdi> </bdi>"),dt=C('<div class="fixed bottom-0 w-full max-w-screen-md flex justify-between shadow-lg" style="box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1), 0 -2px 4px -2px rgba(0, 0, 0, 0.1);"><span class="mx-4"><!></span> <span class="mx-4"> </span></div>'),ht=C('<div id="container" class="search-result p-2 max-w-screen-md w-full"><!> <div id="sentinel" style="height: 1px;"></div></div> <!>',1);function pt(o,e){he(e,!1);const[t,r]=ye(),n=()=>W(ge,"$t",t),d=()=>W(ke,"$language",t),f=()=>W(Ae,"$currentFont",t),D=()=>W(Ne,"$bodyFontSize",t),P=()=>W(Re,"$s",t),O=()=>W(me,"$themeColors",t),S=Q(),F=Q();let E=N(e,"collection",8),g=N(e,"results",8),R=N(e,"queryDone",8),$=N(e,"restore",12),h=N(e,"queryId",8),y=h(),b=Q([]);function v(){if($()){$(!1);const s=localStorage.getItem("search-result-display-length");B(parseInt(s,10))}K()}function J(s){s!==y&&(y=s,_(b,[]))}function z(s){const a=n().Search_Number_Found,u=/%,?d/,x=a.match(u);if(!x)return a;let w;return x[0].includes(",")?w=Intl.NumberFormat(d()).format(s):w=s.toString(),a.replace(u,w)}function B(s=20){_(b,g().slice(0,l(b).length+s)),localStorage.setItem("search-result-display-length",l(b).length.toString())}function X(s){s[0].isIntersecting&&!l(S)&&(B(),K())}function K(){if(g().length===0||g().length===l(b).length)return;const s=document.querySelector("#sentinel"),a=new IntersectionObserver(u=>{u[0].isIntersecting?(B(),K()):a.disconnect()},{root:null,rootMargin:"0px",threshold:.1});a.observe(s)}Ie(()=>{const s=new IntersectionObserver(X,{root:null,rootMargin:"0px",threshold:1}),a=document.querySelector("#sentinel");return a&&s.observe(a),()=>{a&&s.unobserve(a)}}),ie(()=>(ce(R()),ce(g())),()=>{_(S,!R()&&g().length===0)}),ie(()=>ce(h()),()=>{J(h())}),ie(()=>ce(g()),()=>{g(),v()}),ie(()=>ce(g()),()=>{_(F,z(g().length))}),Pe(),de();var G=ht(),j=le(G),ne=i(j);{var V=s=>{var a=ct(),u=i(a),x=i(u,!0);c(u),c(a),H(()=>{U(u,"font-family",f()),U(u,"font-size",`${D()??""}px`),L(x,n().Search_No_Matches_Found)}),q(s,a)},ae=s=>{var a=ze(),u=le(a);{var x=k=>{var I=it(),T=le(I);const Z=oe(()=>re(P()["ui.search.progress-label"]));var ee=i(T),$e=i(ee,!0);c(ee),c(T),fe(2),H(()=>{te(T,"style",l(Z)),U(T,"text-align","center"),L($e,n().Search_Searching)}),q(k,I)},w=k=>{var I=lt(),T=le(I);be(T,1,()=>l(b),we,(Z,ee)=>{at(Z,{get result(){return l(ee)},get collection(){return E()},get docSet(){return l(ee).reference.docSet}})}),fe(2),q(k,I)};se(u,k=>{l(S)?k(x):k(w,!1)},!0)}q(s,a)};se(ne,s=>{R()&&g().length===0?s(V):s(ae,!1)})}fe(2),c(j);var Y=A(j,2);{var m=s=>{var a=dt(),u=i(a),x=i(u);{var w=T=>{var Z=ut(),ee=i(Z,!0);c(Z),H(()=>L(ee,n().Search_Searching)),q(T,Z)};se(x,T=>{R()||T(w)})}c(u);var k=A(u,2),I=i(k,!0);c(k),c(a),H(()=>{U(a,"background-color",O().BackgroundColor),L(I,l(F))}),q(s,a)};se(Y,s=>{g().length&&s(m)})}q(o,G),pe(),r()}function ft(o){return o.type==="docset-url-request"}class vt{constructor(e,t){p(this,"getDocSetUrl");p(this,"baseURI");this.getDocSetUrl=e,this.baseURI=t}requestHandler(){return e=>this.onRequest(e)}async onRequest(e){return ft(e)?this.onDocsetUrlRequest(e):this.onUnknownRequest(e)}onDocsetUrlRequest(e){return{type:"docset-url",url:this.getDocSetUrl(e.docSet),base:this.baseURI}}onUnknownRequest(e){return{type:"error",message:`Unrecognized worker request: ${e.type}`}}}function mt(o){return o.type==="new-query-response"}function gt(o){return o.type==="results-response"}class yt{constructor({id:e,outboundHandler:t}){p(this,"isComplete");p(this,"queryId");p(this,"outboundHandler");this.queryId=e,this.outboundHandler=t}async getResults(e){const t={type:"results-request",limit:e,queryId:this.queryId},r=await this.outboundHandler(t);return this.parseResponse(r)}parseResponse(e){if(gt(e))return this.isComplete=e.queryDone,e.results;throw new Error(`Search query returned invalid message of type ${e.type}: ${e}`)}}function bt(o){return o.type==="error"}class wt{constructor(e,{timeout:t=5e3,inboundHandler:r}={}){p(this,"io");p(this,"requestHandler");p(this,"timeout");p(this,"pendingRequests",new Map);p(this,"lastRequest",-1);this.requestHandler=r,this.io=e,this.timeout=t,e.setOnMessage(n=>this.onMessage(n))}setInboundHandler(e){this.requestHandler=e}outboundHandler(){return e=>this.postRequest(e)}postRequest(e){const t=++this.lastRequest,r={transactionId:t,type:"request",payload:e},n=new Promise((d,f)=>{this.pendingRequests.set(t,{resolve:d,reject:f}),this.io.postMessage(r)});return this.addTimeout(n,e,t)}addTimeout(e,t,r){if(!this.timeout)return e;const n=this.setRequestTimeout(t,r);return Promise.race([e,n])}async setRequestTimeout(e,t){return await new Promise(r=>setTimeout(r,this.timeout)),this.pendingRequests.delete(t),await Promise.reject(new Error(`Message request timed out after ${this.timeout} ms. Request type: ${e.type}`))}onMessage(e){const t=e.data;if((t==null?void 0:t.type)==="request")this.onRequest(t);else if((t==null?void 0:t.type)==="response")this.onResponse(t);else throw new Error(`Invalid message from worker: ${t}`)}async onRequest(e){if(!this.requestHandler)throw new Error("Messenger incoming request handler was undefined. Did you foget to call setInboundHandler?");const t=await this.requestHandler(e.payload),r={transactionId:e.transactionId,type:"response",payload:t};this.io.postMessage(r)}onResponse(e){const t=e.transactionId;if(!this.pendingRequests.has(t))throw new Error(`No callback to handle response for message transaction ${t}`);const r=e.payload,{resolve:n,reject:d}=this.pendingRequests.get(t);bt(r)?d(new Error(r.message)):n(r),this.pendingRequests.delete(t)}}class _t{constructor(e,t,r){p(this,"messenger");p(this,"queryGenerator");p(this,"createQuery",async(e,t)=>{const r=await this.requestNewQuery(e,t),n=this.messenger.outboundHandler();return this.queryGenerator({id:r,outboundHandler:n})});this.messenger=new wt(e,{inboundHandler:r,timeout:null}),this.queryGenerator=t}async requestNewQuery(e,t){const r={type:"new-query-request",phrase:e,options:t},n=await this.messenger.postRequest(r);if(mt(n))return n.queryId;throw new Error(`Upexpected response type for request ${r.type}: ${n.type}`)}}const xe=new Worker(new URL(""+new URL("../workers/worker-script-djbkXHyq.js",import.meta.url).href,import.meta.url),{type:"module"}),St={postMessage:function(o){xe.postMessage(o)},setOnMessage:function(o){xe.onmessage=o}};function xt(){const o=new vt(He,document.baseURI),e=new _t(St,t=>new yt(t),o.requestHandler());return(t,r)=>e.createQuery(t,r)}class qt{searchWholeWordsDefault(){return M.mainFeatures["search-whole-words-default"]}searchAccentsDefault(){return M.mainFeatures["search-accents-default"]}searchAccentsToRemove(){return M.mainFeatures["search-accents-to-remove"]}bookCollection(e){return M.bookCollections.find(t=>t.id===e)}}function qe(o,e,t){o[e]?o[e]+=t:o[e]=t}class Rt{constructor(e){p(this,"config");this.config=e}searchIgnore(){const e=this.config.searchAccentsToRemove();let t="";for(const r of e.matchAll(/\\u(03\d\d)/g)){const n=parseInt(r[1],16),d=String.fromCodePoint(n);t+=d}return t}searchSubtitute(){const e=this.config.searchAccentsToRemove(),t={};for(const r of e.matchAll(/(\S)>(\S)/g))qe(t,r[1],r[2]),qe(t,r[2],r[1]);return t}collectionToDocSet(e){const t=this.config.bookCollection(e);return t.languageCode+"_"+t.id}userLanguage(){return Ee(ke)}}class kt{async save(e){localStorage.setItem("search-results",JSON.stringify(e))}async read(){const e=localStorage.getItem("search-results");return e?JSON.parse(e):null}}class It{constructor(e){p(this,"repo");this.repo=e}configureOptions(e){const t=this.repo.collectionToDocSet(e.collection),r=this.repo.userLanguage(),n=e.matchAccents?void 0:this.repo.searchIgnore(),d=e.matchAccents?void 0:this.repo.searchSubtitute();return{docSet:t,collection:e.collection,wholeWords:e.wholeWords,ignore:n,substitute:d,locale:r}}}class Ct{constructor({queryGenerator:e}){p(this,"createQuery");p(this,"onResults");p(this,"onNewQuery");p(this,"queryID",0);this.createQuery=e}setOnResults(e){this.onResults=e}setOnNewQuery(e){this.onNewQuery=e}async submit(e,t,{batchSize:r=10,limit:n=1/0}={}){this.queryID++;const d=this.queryID;this.onNewQuery&&this.onNewQuery();const f=await this.createQuery(e,t);await this.runQuery(f,d,{batchSize:r,limit:n})}async runQuery(e,t,{batchSize:r,limit:n}){let d=0;for(;!e.isComplete&&d<n;){let f=await e.getResults(r);if(d+f.length>n&&(f=f.slice(0,n-d)),t!=this.queryID)break;this.onResults&&this.onResults(f),d+=f.length}}}class Dt{constructor({presenter:e,config:t,configureOptions:r,queryManager:n,storage:d}){p(this,"presenter");p(this,"config");p(this,"configureOptions");p(this,"queryManager");p(this,"storage");p(this,"results");this.presenter=e,this.config=t,this.configureOptions=r,this.queryManager=n,this.storage=d,n.setOnResults(f=>this.onResults(f)),n.setOnNewQuery(()=>e.onNewQuery()),e.setOptions("",{wholeWords:t.searchWholeWordsDefault(),matchAccents:t.searchAccentsDefault(),collection:""})}onResults(e){this.results.push(...e),this.presenter.onResults(e)}async submit(e,t){this.results=[],await this.queryManager.submit(e,this.configureOptions(t),{batchSize:1,limit:1e3});const r=this.results;this.storage.save({phrase:e,options:t,results:r}),this.presenter.onQueryDone()}async loadLastQuery(){const e=await this.storage.read();e&&(this.presenter.setOptions(e.phrase,e.options),this.presenter.onResults((e==null?void 0:e.results)??[]))}}function $t(o){const e=new qt,t=new Rt(e),r=new It(t),n=xt();return new Dt({presenter:o,config:e,configureOptions:d=>r.configureOptions(d),queryManager:new Ct({queryGenerator:n}),storage:new kt})}var Qt=C('<label for="sidebar"><div class="btn btn-ghost normal-case text-xl"> </div></label>'),Mt=C('<div class="grid grid-rows-[auto,1fr,auto]" style="height:100vh;height:100dvh;"><div class="navbar"><!></div> <div class="overflow-auto"><div class="flex justify-center"><!></div> <div class="flex justify-center px-4"><hr class="max-w-screen-md w-full"></div> <div class="flex justify-center"><!></div></div></div>');function Vt(o,e){he(e,!1);const[t,r]=ye(),n=()=>W(ge,"$t",t),d=()=>W(me,"$themeColors",t);let f=N(e,"data",8),D=Q(),P=Q(),O=Q(),S=Q([]),F=Q(0),E=Q(!0),g=Q(!1),R=Q(),$=0,h=!1;const b=$t({setOptions(s,a){_(D,s),_(P,a.wholeWords),_(O,a.matchAccents)},onResults(s){_(S,l(S).concat(s))},onNewQuery(){_(S,[]),_(E,!1)},onQueryDone(){_(E,!0)}});function v(s){Fe(We(`/search/${f().collection}?savedResults=true`)),je(F);const a={collection:f().collection,wholeWords:s.detail.wholeWords,matchAccents:s.detail.matchAccents};b.submit(s.detail.phrase,a)}function J(){h=!1,$=l(R).scrollTop;const s=$;setTimeout(()=>{$===s&&!h&&(localStorage.setItem("search-scroll-pos",$.toString()),h=!0)},100)}async function z(){if(new URLSearchParams(window.location.search).get("savedResults")){_(g,!0),await b.loadLastQuery(),_(g,!1);const a=localStorage.getItem("search-scroll-pos");Le(R,l(R).scrollTop=a?parseInt(a,10):0),J()}}Ie(()=>(z(),()=>{h||(h=!0,localStorage.setItem("search-scroll-pos",$.toString()))})),de();var B=Mt(),X=i(B),K=i(X);Be(K,{center:a=>{var u=Qt(),x=i(u),w=i(x,!0);c(x),c(u),H(()=>L(w,n().Search)),q(a,u)},$$slots:{center:!0}}),c(X);var G=A(X,2),j=i(G),ne=i(j);rt(ne,{get phrase(){return l(D)},set phrase(s){_(D,s)},get wholeWords(){return l(P)},set wholeWords(s){_(P,s)},get matchAccents(){return l(O)},set matchAccents(s){_(O,s)},$$events:{submit:v},$$legacy:!0}),c(j);var V=A(j,2),ae=i(V);c(V);var Y=A(V,2),m=i(Y);pt(m,{get collection(){return f().collection},get results(){return l(S)},get queryId(){return l(F)},get queryDone(){return l(E)},get restore(){return l(g)}}),c(Y),c(G),Ce(G,s=>_(R,s),()=>l(R)),c(B),H(()=>U(ae,"border-color",d().DividerColor)),ue("scroll",G,J),q(o,B),pe(),r()}export{Vt as component,Xt as universal};
